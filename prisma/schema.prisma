generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = "mysql://schoolAttendance:Sensarsoft%40123@[2a02:4780:12:f6a7::1]:3306/pharmacy_management"
}

enum Role {
  ADMIN
  ADMINISTRATOR
}

enum AppPaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUND
}

enum StockMovementType {
  IN
  OUT
}

enum PaymentMode {
  CASH
  ONLINE
}

model Shop {
  shop_id    Int       @id @default(autoincrement())
  name       String
  address    String
  phone      String
  email      String
  logo       Bytes?
  gst_number String? // ✅ GST Number
  dl_number  String? // ✅ Drug License Number
  tin_number String? // ✅ TIN Number
  created_at DateTime  @default(now())
  duedate    DateTime?
  is_active  Boolean   @default(true)

  users           User[]
  admins          Admin[]
  administrators  Administrator[]
  payments        AppPayment[]
  blocks          ShopBlock[]
  SubmitTicket    SubmitTicket[]
  Message         Message[]
  finances        Finance[]
  medicines       Medicine[]
  medicineBatches MedicineBatch[]
  bills           Bill[]
  stockMovements  StockMovement[]
  orderReceiveds  OrderReceived[]

  @@unique([name, address])
}

model User {
  user_id   String
  shop_id   Int
  role      Role    @default(ADMIN)
  password  String
  is_active Boolean @default(true)

  shop          Shop           @relation(fields: [shop_id], references: [shop_id])
  admin         Admin?
  administrator Administrator?
  finances      Finance[]
  submitTickets SubmitTicket[]
  bills         Bill[]

  @@id([user_id, shop_id])
}

model Admin {
  id          Int    @id @default(autoincrement())
  shop_id     Int
  user_id     String
  name        String
  designation String
  phone       String
  email       String

  shop Shop @relation(fields: [shop_id], references: [shop_id])
  user User @relation(fields: [user_id, shop_id], references: [user_id, shop_id])

  @@unique([user_id, shop_id])
}

model Administrator {
  id      Int    @id @default(autoincrement())
  user_id String
  shop_id Int
  name    String
  phone   String
  email   String

  shop Shop @relation(fields: [shop_id], references: [shop_id])
  user User @relation(fields: [user_id, shop_id], references: [user_id, shop_id])

  @@unique([user_id, shop_id])
}

model AppPayment {
  id            Int              @id @default(autoincrement())
  shop_id       Int
  baseAmount    Int
  gst           Float
  amount        Float
  paidAt        DateTime         @default(now())
  periodStart   DateTime
  periodEnd     DateTime
  transactionId String?
  status        AppPaymentStatus @default(PENDING)
  createdAt     DateTime         @default(now())

  shop Shop @relation(fields: [shop_id], references: [shop_id])
}

model ShopBlock {
  id      Int    @id @default(autoincrement())
  shop_id Int
  reason  String

  shop Shop @relation(fields: [shop_id], references: [shop_id])
}

model Finance {
  id         Int       @id @default(autoincrement())
  shop_id    Int
  user_id    String
  reason     String
  type       String?
  state      String?
  amount     Float
  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  shop Shop @relation(fields: [shop_id], references: [shop_id])
  user User @relation(fields: [user_id, shop_id], references: [user_id, shop_id])
}

model SubmitTicket {
  id         Int      @id @default(autoincrement())
  shop_id    Int
  user_id    String
  issue      String
  created_at DateTime @default(now())

  shop Shop @relation(fields: [shop_id], references: [shop_id])
  user User @relation(fields: [user_id, shop_id], references: [user_id, shop_id])
}

model Message {
  id         Int      @id @default(autoincrement())
  shop_id    Int
  message    String
  created_at DateTime @default(now())

  shop Shop @relation(fields: [shop_id], references: [shop_id])
}

enum MedicineOrderStatus {
  ORDERED
  NOT_ORDERED
}

model Medicine {
  id           Int                 @id @default(autoincrement())
  shop_id      Int
  name         String
  category     String
  stock        Int
  ndc_code     String?
  reorder      Int?
  order_status MedicineOrderStatus @default(NOT_ORDERED) // ✅ new field
  is_active    Boolean             @default(true)
  created_at   DateTime            @default(now())

  shop           Shop            @relation(fields: [shop_id], references: [shop_id])
  batches        MedicineBatch[]
  billItems      BillItem[]
  orderReceiveds OrderReceived[]
}

enum OrderStatus {
  ORDERED
  RECEIVED
}

model OrderReceived {
  id            Int         @id @default(autoincrement())
  shop_id       Int
  medicine_id   Int
  quantity      Int
  supplier_id   Int // ✅ ADD THIS
  status        OrderStatus @default(ORDERED)
  order_date    DateTime    @default(now())
  received_date DateTime? // ✅ Date when the order is actually received
  created_at    DateTime    @default(now())
  updated_at    DateTime?   @updatedAt

  shop     Shop     @relation(fields: [shop_id], references: [shop_id])
  medicine Medicine @relation(fields: [medicine_id], references: [id])
  supplier Supplier @relation(fields: [supplier_id], references: [id]) // ✅ RELATION

  @@index([shop_id])
  @@index([supplier_id])
}

model MedicineBatch {
  id                      Int      @id @default(autoincrement())
  shop_id                 Int
  medicine_id             Int
  HSN                     String?
  batch_no                String
  expiry_date             DateTime
  manufacture_date        DateTime
  total_stock             Int?
  total_quantity          Int?
  quantity                Int
  free_quantity           Int?
  unit                    Int
  rack_no                 String?
  mrp                     Float?
  profit                  Float?
  purchase_price_unit     Float
  purchase_price_quantity Float
  selling_price_quantity  Float
  selling_price_unit      Float
  purchase_details        Json?
  supplier_id             Int? // ✅ THIS WAS MISSING
  is_active               Boolean  @default(true)
  created_at              DateTime @default(now())

  shop     Shop      @relation(fields: [shop_id], references: [shop_id])
  medicine Medicine  @relation(fields: [medicine_id], references: [id])
  supplier Supplier? @relation(fields: [supplier_id], references: [id])

  movements StockMovement[]
  billItems BillItem[]

  @@unique([shop_id, medicine_id, batch_no])
}

model StockMovement {
  id            Int               @id @default(autoincrement())
  shop_id       Int
  batch_id      Int
  movement_type StockMovementType
  quantity      Int
  reason        String
  reference     String?
  movement_date DateTime          @default(now())

  shop  Shop          @relation(fields: [shop_id], references: [shop_id])
  batch MedicineBatch @relation(fields: [batch_id], references: [id])
}

model Bill {
  bill_id       Int
  shop_id       Int
  user_id       String
  customer_name String
  phone         String
  doctor_name   String?
  subtotal      Float?
  tax           Float?
  discount      Float?
  total         Float
  paid_amount   Float?
  payment_mode  PaymentMode
  created_at    DateTime    @default(now())

  shop  Shop       @relation(fields: [shop_id], references: [shop_id])
  user  User       @relation(fields: [user_id, shop_id], references: [user_id, shop_id])
  items BillItem[]

  @@id([shop_id, bill_id]) // ✅ composite primary key
}

model BillItem {
  id          Int   @id @default(autoincrement())
  shop_id     Int
  bill_id     Int
  medicine_id Int
  batch_id    Int
  unit        Int
  unit_price  Float
  total_price Float

  bill     Bill          @relation(fields: [shop_id, bill_id], references: [shop_id, bill_id])
  medicine Medicine      @relation(fields: [medicine_id], references: [id])
  batch    MedicineBatch @relation(fields: [batch_id], references: [id])
}

model Supplier {
  id             Int             @id @default(autoincrement())
  shop_id        Int
  name           String
  phone          String
  email          String?
  address        String?
  is_active      Boolean         @default(true)
  created_at     DateTime        @default(now())
  batches        MedicineBatch[]
  orderReceiveds OrderReceived[]

  @@unique([shop_id, name, phone])
}
